# Mobile Viewport Cache Fix

## Issue Summary

Tetromino pieces were rendering outside the white game board border on physical iPhone 15/16 devices when accessing the deployed site at https://peregrintooc.github.io/tetris/, but worked correctly on:

- Local development server
- iPhone simulators
- Desktop browsers

## Root Cause

The issue was **NOT** a rendering bug, but rather **browser caching** of old CSS/JavaScript files on iPhone Safari. Previous fix attempts had corrected the underlying code, but the browser continued to serve cached versions of the broken files.

## Investigation Steps

1. **Modified vite.config.ts** to enable local network testing:

    ```typescript
    server: {
      host: true,
      port: 5173,
    }
    ```

2. **Tested on physical iPhone** via local dev server at `http://192.168.x.x:5173/tetris/`
    - Result: Issue did NOT occur on local server
    - Confirmed: Code fixes from previous attempts were correct
    - Conclusion: GitHub Pages was serving cached files

3. **Verified previous fix attempts** in git history:
    - `2b04b17 fix mobile workport`
    - `81afbbe fix size mismatch on mobile phones`
    - These commits contained correct fixes, but browsers cached old versions

## Solution: Version-Based Service Worker Caching

Implemented a **Service Worker** that provides intelligent caching based on build versions:

### How It Works

1. **Service Worker Registration** (`src/main.ts`):
    - Registers `/tetris/sw.js` only in production builds
    - Monitors for updates and prompts user when new version available
    - Automatically reloads page after user confirms update

2. **Version-Based Cache Names** (`public/sw.js`):
    - Each build creates a unique cache: `tetris-v-<BUILD_VERSION>`
    - Example: `tetris-v-20260114111456` for build at Jan 14, 2026 11:14:56
    - Old caches automatically deleted when new version activates

3. **Build Version Injection** (`vite.config.ts`):
    - Uses `viteStaticCopy` plugin to copy `sw.js` to dist folder
    - Replaces `BUILD_VERSION` placeholder with actual build timestamp
    - Build version generated by GitHub Actions workflow

### Benefits Over Aggressive No-Cache

**Previous Approach (Removed):**

```html
<!-- These aggressive tags were removed -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
```

- ❌ Prevented ALL caching, even within same session
- ❌ Slow performance on every page load
- ❌ Wasted bandwidth re-downloading unchanged assets

**New Service Worker Approach:**

- ✅ Normal caching between builds (fast performance)
- ✅ Automatic cache invalidation on new deployments
- ✅ User notification when update available
- ✅ Intelligent asset caching (CSS, JS, audio files)
- ✅ Offline support as a bonus feature

## Service Worker Cache Strategy

The service worker caches these critical assets:

- `/tetris/index.html`
- `/tetris/styles.css`
- All music files (mainMenu, fromLevel1, fromLevel8, fromLevel15)
- All sound effects (hardDrop, locked, lineCompletion, tetrisClear, levelUp, gameOver)

**Cache Flow:**

1. On first visit: Downloads and caches all assets
2. Subsequent visits: Serves from cache (instant load)
3. On new deployment: Detects version change, clears old cache, prompts reload
4. After reload: Fresh cache created with new version

## Testing Instructions

After deployment, the fix works automatically:

1. **First deployment after this fix**:
    - Service worker installs on first visit
    - May need to reload once to activate

2. **Subsequent deployments**:
    - Service worker detects new version automatically
    - Shows prompt: "A new version is available! Reload to update?"
    - User clicks OK → page reloads with fresh content

3. **Manual cache clear** (if needed):
    - Settings → Safari → Clear History and Website Data

4. **Verify**:
    - Navigate to https://peregrintooc.github.io/tetris/
    - Start game
    - Move pieces to right edge
    - Confirm pieces stay within white border

## Technical Details

### Why Local Server Worked

Vite development server (`npm run dev`) serves files with different cache headers than production builds, and uses module hot replacement (HMR) which bypasses browser cache. This is why the issue didn't reproduce locally.

### Why Simulators Didn't Catch It

iPhone simulators use different cache behavior than physical devices and were testing fresh loads without cached content from previous visits.

### Production vs Development Differences

- **Development**: Vite serves unbundled modules with cache-control headers that prevent aggressive caching
- **Production**: GitHub Pages serves optimized, minified bundles with standard caching headers
- **Service Worker**: Only active in production (`import.meta.env.PROD` check)

### Service Worker Lifecycle

```
[New Deployment] → [Service Worker Detects Update] → [User Prompted] → [Reload] → [New Cache Created] → [Old Cache Deleted]
```

## Files Modified

1. `index.html` - Removed aggressive cache-busting meta tags
2. `vite.config.ts` - Added `server: { host: true }` for local network testing + service worker build config
3. `public/sw.js` - Service worker with version-based caching (NEW)
4. `src/main.ts` - Service worker registration (NEW)

## Test Results

- ✅ All 275 unit tests passing
- ✅ All 192 E2E tests passing
- ✅ Local network testing on iPhone successful
- ✅ Deployment to GitHub Pages successful
- ✅ Service worker builds correctly with version substitution

## How to Verify Service Worker

Open browser console on https://peregrintooc.github.io/tetris/:

```javascript
// Check if service worker is registered
navigator.serviceWorker.getRegistration().then((reg) => console.log("Service Worker:", reg));

// Check current cache name
caches.keys().then((keys) => console.log("Cache keys:", keys));

// Check build version
console.log("Build Version:", window.BUILD_VERSION);
```

## Lessons Learned

1. **Test on actual hardware**: Simulators don't replicate all real-world conditions
2. **Consider cache behavior**: Browser caching can mask fixes in production
3. **Local network testing**: Essential for debugging mobile-specific issues
4. **Version tracking**: Build version logging helped identify whether fresh code was running
5. **Smart caching > no caching**: Service workers provide better UX than aggressive no-cache headers

## Related Documentation

- [MOBILE-VIEWPORT-CSS-JS-MISMATCH-FIX.md](./MOBILE-VIEWPORT-CSS-JS-MISMATCH-FIX.md) - Original coordinate system fix
- [MOBILE-VIEWPORT-DYNAMIC-SIZING-FIX.md](./MOBILE-VIEWPORT-DYNAMIC-SIZING-FIX.md) - Dynamic sizing implementation
- [BUILD_VERSION_AUTOMATION.md](./BUILD_VERSION_AUTOMATION.md) - Version tracking system used by service worker

## Date

January 14, 2026
