(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();const T=class T{static get BLOCK_SIZE(){if(!this.isMobileViewport())return this.DESKTOP_BLOCK_SIZE;const e=window.innerWidth*this.MOBILE_GAME_WIDTH_VW/100;return Math.floor(e/this.BOARD_WIDTH_BLOCKS)}static isMobileViewport(){return window.innerWidth<=768}static get BOARD_WIDTH_PX(){return this.BLOCK_SIZE*this.BOARD_WIDTH_BLOCKS}static get BOARD_HEIGHT_PX(){return this.BLOCK_SIZE*this.BOARD_HEIGHT_BLOCKS}static getMobilePreviewWidth(){if(!this.isMobileViewport())return this.PREVIEW_BOARD_WIDTH;const t=this.BLOCK_SIZE;return Math.floor(t*6)}static getMobileHoldWidth(){if(!this.isMobileViewport())return this.HOLD_BOARD_WIDTH;const t=this.BLOCK_SIZE;return Math.floor(t*6)}};T.DESKTOP_BLOCK_SIZE=24,T.BOARD_WIDTH_BLOCKS=11,T.BOARD_HEIGHT_BLOCKS=20,T.PREVIEW_BOARD_WIDTH=112,T.HOLD_BOARD_WIDTH=112,T.HOLD_CONTAINER_SIZE=112,T.MOBILE_GAME_WIDTH_VW=47;let y=T;class G{constructor(t){this.coordinateBlocks=new Map,this.shadowBlocks=new Map,this.board=t}renderTetromino(t){this.renderCoordinateBlocks(t)}clearTetromino(t){this.clearCoordinateBlocks(t)}renderCoordinateBlocks(t){this.clearCoordinateBlocks(t),t.element.style.display="none",t.getBlocks().forEach(e=>{const i=this.createCoordinateBlock(e,t),o=`${t.id}-${e.x}-${e.y}`;this.coordinateBlocks.set(o,i),this.board.appendChild(i)})}clearCoordinateBlocks(t){const e=t.id,i=[];this.coordinateBlocks.forEach((o,s)=>{s.startsWith(`${e}-`)&&(o.remove(),i.push(s))}),i.forEach(o=>this.coordinateBlocks.delete(o))}createCoordinateBlock(t,e){const i=document.createElement("div");return i.className=`coordinate-block ${e.getClassName()}-coordinate-block`,i.style.position="absolute",i.style.width=e.size+"px",i.style.height=e.size+"px",i.style.left=`${t.x*e.size}px`,i.style.top=`${t.y*e.size}px`,i.setAttribute("data-tetromino-id",e.id),i}updateTetromino(t){this.renderTetromino(t)}renderShadowBlocks(t,e){this.clearShadowBlocks(t),t.getBlocks().forEach((o,s)=>{const l=this.createShadowBlock(o,t,e),c=`${t.id}-shadow-${s}`;this.shadowBlocks.set(c,l),this.board.appendChild(l)})}clearShadowBlocks(t){if(!t)return;const e=t.id,i=[];this.shadowBlocks.forEach((o,s)=>{s.startsWith(`${e}-shadow-`)&&(o.remove(),i.push(s))}),i.forEach(o=>this.shadowBlocks.delete(o))}createShadowBlock(t,e,i){const o=document.createElement("div");return o.className=`shadow-block ${e.getClassName()}-shadow-block`,o.style.position="absolute",o.style.width=e.size+"px",o.style.height=e.size+"px",o.style.left=`${t.x*e.size}px`,o.style.top=`${(t.y+i)*e.size}px`,o.setAttribute("data-tetromino-id",e.id),o}}class pt{constructor(t){this.element=t,this.previewContainer=t.querySelector("#preview-container"),this.blockRenderer=new G(this.previewContainer),this._applyDimensions()}_applyDimensions(){this.element.style.width=y.PREVIEW_BOARD_WIDTH+"px"}showNextTetromino(t){this.previewContainer.innerHTML="";const e=(y.PREVIEW_BOARD_WIDTH-t.size*2)/2,i=t.board;t.board={getBlockRenderer:()=>this.blockRenderer,getBlockSize:()=>y.BLOCK_SIZE};const o=t.left,s=t.top;t.left=Math.floor(e/t.size),t.top=Math.floor(e/t.size),this.blockRenderer.renderTetromino(t),t.left=o,t.top=s,t.board=i}}class n{constructor({x:t,y:e,parent:i}){this.x=t,this.y=e,this.parent=i}drop(){const t=this.parent?.board;if(t&&typeof t.getHeight=="function"){const e=t.getHeight()-1;if(this.y>=e){console.warn(`Block cannot drop: already at maximum y (${this.y} >= ${e})`);return}}this.y++}delete(){this.parent.removeBlock(this)}log(){console.log("  Block ->",{x:this.x,y:this.y,tetrominoId:this.parent?.id})}}const $=class ${constructor(t,e,i){this.paused=!1,this.blocks=[],this.id=($.nextId++).toString(),this.seed=i,this.pivot=new n({x:t,y:0,parent:this}),this.board=e,this.locked=!1,this.rotation=0,this.element=this._createElement(),this.blocks=this.getBlocks(),this.board&&this.board.addTetromino(this)}get size(){return this.board&&typeof this.board.getBlockSize=="function"?this.board.getBlockSize():y.BLOCK_SIZE}pause(){this.paused=!this.paused}collapseBlocks(){let e=0,i=!0;for(;i&&e<100;){i=!1,e++;for(const o of this.blocks){const s=this.blocks.filter(l=>l.x===o.x&&l.y>o.y);s.length>0&&Math.min(...s.map(c=>c.y))-1>o.y&&(o.drop(),i=!0)}}e>=100&&console.warn("Block collapse exceeded maximum iterations. Possible infinite loop prevented.")}dropByOne(){this.blocks.forEach(t=>t.drop())}get left(){return this.pivot.x}set left(t){this.pivot.x=t}get top(){return this.pivot.y}set top(t){this.pivot.y=t}reset(){this.left=Math.floor((this.board?.width||10)/2),this.top=0,this.rotation=0,this.locked=!1,this.paused=!1,this.updatePosition(),this.updateBlocks()}createBlocks(){this.blocks=this.getBlocks()}removeBlock(t){this.blocks=this.blocks.filter(e=>e!==t),this.updateBlocks(),this.blocks.length===0&&this.board&&this.board.removeTetromino(this)}_createElement(){return this._createDiv(this.getClassName())}collides(t,e,i){return this.getBlocks().map(({x:s,y:l})=>({x:s+t,y:l+e})).some(({x:s,y:l})=>i.some(({x:c,y:d})=>c===s&&d===l))}_createDiv(t,e=0,i=0,o=this.size){const s=document.createElement("div");return s.className=t,s.style.width=o+"px",s.style.height=o+"px",s.style.position="absolute",s.style.left=e*o+"px",s.style.top=i*o+"px",s.setAttribute("data-tetromino-id",this.id),s}move(t){const e=this.board;if(!e||this.locked)return;e.moveTetromino(this,t)&&t==="down"&&this._dispatchScoreEvent(10)}drop(){if(!this.board||this.locked)return;let t=0;for(;this.board.moveTetromino(this,"down");)t++;if(t>0){this._dispatchScoreEvent(t*15);const e=new Event("hardDrop");this.element.dispatchEvent(e)}this.lock()}_dispatchScoreEvent(t){const e=new CustomEvent("scoreEvent",{detail:{points:t},bubbles:!0});this.element.dispatchEvent(e)}addEventListener(t,e){this.element.addEventListener(t,e)}updatePosition(){this.element.style.top=this.top*this.size+"px",this.element.style.left=this.left*this.size+"px",this.board&&typeof this.board.getBlockRenderer=="function"&&this.board.getBlockRenderer().updateTetromino(this)}lock(){if(this.locked)return;this.stopListening(),this.blocks=this.getBlocks(),this.locked=!0,this.board&&typeof this.board.getBlockRenderer=="function"&&this.board.getBlockRenderer().clearShadowBlocks(this),this._dispatchScoreEvent(5),this.board&&typeof this.board.prepareForLock=="function"&&this.board.prepareForLock(this.getBlocks());const t=new CustomEvent("locked",{detail:this.getBlocks()});this.element.dispatchEvent(t)}_setupKeyboardListener(t){this.keyboardListener=e=>{if(this.locked||!this.board||this.paused)return;const i=t.getActionForKey(e.key);if(i)switch(i){case"moveLeft":this.move("left");break;case"moveRight":this.move("right");break;case"softDrop":this.move("down");break;case"hardDrop":e.preventDefault&&e.preventDefault(),this.drop();break;case"rotateClockwise":this.rotate();break;case"rotateCounterClockwise":this.rotate(-1);break;case"hold":this.board&&this.board.hold();break}},document.addEventListener("keydown",this.keyboardListener)}_removeKeyboardListener(){this.keyboardListener&&(document.removeEventListener("keydown",this.keyboardListener),this.keyboardListener=void 0)}startFalling(){!this.board||this.locked||(this.fallListener=()=>{!this.locked&&this.board&&(this.board.moveTetromino(this,"down")||this.lock())},document.addEventListener("tick",this.fallListener))}stopListening(){document.removeEventListener("tick",this.fallListener),this.deactivateKeyboardControl()}activateKeyboardControl(t){this._removeKeyboardListener(),this._setupKeyboardListener(t)}deactivateKeyboardControl(){this._removeKeyboardListener()}rotate(t=1){const e=this.board,i=this.rotation,o=this.left,s=this.top;this.rotation+=t;const l=e.width||10,c=o,x=l-1-o<c?[{dx:0,dy:0},{dx:-1,dy:0},{dx:1,dy:0},{dx:-2,dy:0},{dx:2,dy:0},{dx:-1,dy:1},{dx:1,dy:1},{dx:-2,dy:1},{dx:2,dy:1},{dx:0,dy:1},{dx:0,dy:-1},{dx:0,dy:-2}]:[{dx:0,dy:0},{dx:1,dy:0},{dx:-1,dy:0},{dx:2,dy:0},{dx:-2,dy:0},{dx:1,dy:1},{dx:-1,dy:1},{dx:2,dy:1},{dx:-2,dy:1},{dx:0,dy:1},{dx:0,dy:-1},{dx:0,dy:-2}];for(const I of x){this.left=o+I.dx,this.top=s+I.dy;const D=this.getBlocks();if(e.inBounds(D)&&!e.collision(D)){if(this.blocks=D,this.updateBlocks(),e&&typeof e.calculateDropDistance=="function"){const A=e.getBlockRenderer();A.clearShadowBlocks(this);const H=e.calculateDropDistance(this);A.renderShadowBlocks(this,H)}return}}this.rotation=i,this.left=o,this.top=s}updateBlocks(){this.blocks=this.getBlocks(),this.board&&typeof this.board.getBlockRenderer=="function"&&this.board.getBlockRenderer().updateTetromino(this)}log(){console.log(" Tetromino ->",{id:this.id,left:this.left,top:this.top,locked:this.locked}),this.blocks&&this.blocks.length>0&&(console.log("  Blocks:"),this.blocks.forEach(t=>{t.log?t.log():console.log("    ",{x:t.x,y:t.y})}))}};$.nextId=1;let b=$;class mt extends b{getClassName(){return"tetromino tetromino-t"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%4){case 0:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this})];break;case 1:t=[this.pivot,new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this})];break;case 2:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this})];break;default:t=[this.pivot,new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y,parent:this})]}return this.blocks=t,t}}class ft extends b{getClassName(){return"tetromino tetromino-i"}getBlocks(){if(this.locked)return this.blocks;let t;return this.rotation%2===0?t=[new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),this.pivot,new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+2,y:this.pivot.y,parent:this})]:t=[new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),this.pivot,new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+2,parent:this})],this.blocks=t,t}}class vt extends b{getClassName(){return"tetromino tetromino-o"}createBlocks(){const t=[new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),this.pivot];this.blocks=t}getBlocks(){if(this.locked)return this.blocks;const t=[new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),this.pivot];return this.blocks=t,t}rotate(){}}class yt extends b{getClassName(){return"tetromino tetromino-j"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%4){case 0:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this})];break;case 1:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y-1,parent:this})];break;case 2:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y-1,parent:this})];break;default:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y+1,parent:this})]}return this.blocks=t,t}}class gt extends b{getClassName(){return"tetromino tetromino-l"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%4){case 0:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y+1,parent:this})];break;case 1:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this})];break;case 2:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y-1,parent:this})];break;default:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y-1,parent:this})]}return this.blocks=t,t}}class kt extends b{getClassName(){return"tetromino tetromino-z"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%2){case 0:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this})];break;default:t=[new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y+1,parent:this})]}return this.blocks=t,t}}class wt extends b{getClassName(){return"tetromino tetromino-s"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%2){case 0:t=[this.pivot,new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y+1,parent:this})];break;default:t=[new n({x:this.pivot.x-1,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),this.pivot,new n({x:this.pivot.x,y:this.pivot.y+1,parent:this})]}return this.blocks=t,t}}class st extends b{getClassName(){return"tetromino"}getBlocks(){if(this.locked)return this.blocks;const t=[this.pivot];return this.blocks=t,t}}class J{static createNew(t,e,i){let o;switch(i){case 0:o=new mt(t,e);break;case 1:o=new ft(t,e);break;case 2:o=new vt(t,e);break;case 3:o=new yt(t,e);break;case 4:o=new gt(t,e);break;case 5:o=new kt(t,e);break;case 6:o=new wt(t,e);break;case 1337:o=new st(t,e);break;default:o=new st(t,e)}return o.seed=i,o}}const ht=200,xt=200,bt=ht+xt;class Tt{constructor(t,e,i,o,s,l=null,c=null,d=null,g=y.BLOCK_SIZE,x=null){this.nextTetromino=null,this.occupiedPositions=[],this.coordinateBlocks=new Map,this.canHoldPiece=!0,this.keyBindingManager=null,this.audioManager=null,this.isAnimating=!1,this.animationTimeouts=[],this.historyManager=null,this.height=t,this.width=e,this.blockSize=g,this.element=i,this.previewBoard=o,this.holdBoard=l,this.tetrominos=new Set,this.nextTetromino=null,this.tetrominoSeedQueue=s,this.keyBindingManager=c,this.audioManager=d,this.blockRenderer=new G(i),this.historyManager=x,this._applyDimensions(),this._initializeCanvas()}_applyDimensions(){const t=y.BOARD_WIDTH_PX,e=y.BOARD_HEIGHT_PX;this.element.style.width=t+"px",this.element.style.height=e+"px"}_initializeCanvas(){const t=this.element.querySelector("canvas");if(!t)return;const e=y.BOARD_WIDTH_PX,i=y.BOARD_HEIGHT_PX;t.width=e,t.height=i}reset(){this._cancelAnimation(),this.tetrominos.clear(),this.occupiedPositions=[],this.coordinateBlocks.clear(),this.nextTetromino=null,this.activeTetromino&&this.activeTetromino.stopListening(),this.activeTetromino=null,this.element.innerHTML=""}registerEventListener(t,e){this.element.addEventListener(t,e)}pauseGame(){this.isAnimating||(this.activeTetromino.pause(),this._updateShadowBlocks())}hold(){if(this.isAnimating||!this.holdBoard||!this.canHoldPiece||this.activeTetromino.locked)return;const{storedTetromino:t,currentTetromino:e}=this._resetActiveTetromino();t?this._swap(e,t):this._moveToHoldBoard(e),this.takeSnapshot()}_moveToHoldBoard(t){this.holdBoard.showHeldTetromino(t),t.board=null,this.spawnTetromino()}_swap(t,e){this.holdBoard.showHeldTetromino(t),t.board=null,this.blockRenderer.clearTetromino(e),this.addTetromino(e),e.reset(),e.startFalling(),this.keyBindingManager&&this.activeTetromino.activateKeyboardControl(this.keyBindingManager)}_resetActiveTetromino(){this.activeTetromino.stopListening();const t=this.activeTetromino,e=this.holdBoard.getHeldTetromino();return this.blockRenderer.clearTetromino(t),this.blockRenderer.clearShadowBlocks(t),this.tetrominos.delete(t),this.canHoldPiece=!1,{storedTetromino:e,currentTetromino:t}}addTetromino(t){this.tetrominos.add(t),this.element.appendChild(t.element),this.activeTetromino=t,t.board=this,t.addEventListener("locked",this._handleTetrominoLocked.bind(this)),this.blockRenderer.renderTetromino(t),this._updateShadowBlocks()}removeTetromino(t){this.tetrominos.has(t)&&(this.occupiedPositions.some(e=>e.parent.id===t.id)&&(console.error("Removing tetromino with id "+t.id+" with blocks still in occupiedPositions:"),t.log(),this.log(),this.occupiedPositions=this.occupiedPositions.filter(e=>e.parent.id!==t.id)),this.tetrominos.delete(t))}_getMovementDelta(t){let e=0,i=0;return t==="left"&&(e=-1),t==="right"&&(e=1),t==="down"&&(i=1),{dx:e,dy:i}}_isValidMove(t,{dx:e,dy:i},o){return!(!t.getBlocks().map(({x:c,y:d})=>({x:c+e,y:d+i})).every(({x:c,y:d})=>c>=0&&c<this.width&&d>=0&&d<this.height)||!this._canMove(o))}_applyMovement(t,e){e==="left"&&t.left--,e==="right"&&t.left++,e==="down"&&t.top++,t.updatePosition()}moveTetromino(t,e){return this.isAnimating||!this._isValidMove(t,this._getMovementDelta(e),e)?!1:(this._applyMovement(t,e),this._updateShadowBlocks(),!0)}calculateDropDistance(t){let e=0;const i=t.getBlocks();for(;e<this.height;){const o=i.map(({x:c,y:d})=>({x:c,y:d+e+1,parent:t}));if(!o.every(({x:c,y:d})=>c>=0&&c<this.width&&d>=0&&d<this.height)||this.occupiedPositions.some(c=>o.some(d=>c.x===d.x&&c.y===d.y)))break;e++}return e}_updateShadowBlocks(){if(!this.activeTetromino||this.activeTetromino.locked||this.activeTetromino.paused){this.blockRenderer.clearShadowBlocks(this.activeTetromino);return}const t=this.calculateDropDistance(this.activeTetromino);this.blockRenderer.renderShadowBlocks(this.activeTetromino,t)}spawnTetromino(){if(this.isAnimating)return this.activeTetromino;let t;const e=Math.floor(this.width/2);return this.nextTetromino?t=this._reuseNextTetromino():t=this._createNewTetromino(e),this._configureTetrominoListeners(t),t.startFalling(),this._prepareNextTetromino(e),this.takeSnapshot(),t}_prepareNextTetromino(t){this.nextTetromino=J.createNew(t,null,this.tetrominoSeedQueue.dequeue()),this.nextTetromino.updatePosition(),this.previewBoard&&this.previewBoard.showNextTetromino&&this.previewBoard.previewContainer&&this.previewBoard.showNextTetromino(this.nextTetromino)}_configureTetrominoListeners(t){t.addEventListener("locked",()=>{this.audioManager&&this.audioManager.playSoundEffect("locked")}),t.addEventListener("hardDrop",()=>{this.audioManager&&this.audioManager.playSoundEffect("hardDrop")}),this.keyBindingManager&&t.activateKeyboardControl(this.keyBindingManager)}_createNewTetromino(t){const e=J.createNew(t,this,this.tetrominoSeedQueue.dequeue());return e.updatePosition(),e}getActiveTetromino(){return this.activeTetromino}getBlockRenderer(){return this.blockRenderer}getHeight(){return this.height}getBlockSize(){return y.BLOCK_SIZE}takeSnapshot(){this.historyManager&&this.historyManager.takeSnapshot(this)}getHistoryManager(){return this.historyManager}restoreFromSnapshot(t){this._cancelAnimation(),this.activeTetromino&&this.activeTetromino.stopListening(),this.element.innerHTML="";const e=t.getRestoredState(this);this.occupiedPositions=e.occupiedPositions,this.canHoldPiece=e.canHoldPiece,this.tetrominos.clear();for(const i of e.lockedTetrominos)this.tetrominos.add(i),this.element.appendChild(i.element),this.blockRenderer.updateTetromino(i);this.activeTetromino=e.activeTetromino,this.activeTetromino.board=this,this.element.appendChild(this.activeTetromino.element),this.blockRenderer.renderTetromino(this.activeTetromino),this.nextTetromino=e.nextTetromino,this.previewBoard&&this.nextTetromino&&this.previewBoard.showNextTetromino(this.nextTetromino),this._configureTetrominoListeners(this.activeTetromino),this.keyBindingManager&&this.activeTetromino.activateKeyboardControl(this.keyBindingManager),this._updateShadowBlocks()}_assertInBounds(t,e,i=""){if(t<0||t>=this.width||e<0||e>=this.height)throw new Error(`Block coordinate out of bounds: (${t}, ${e}) not in [0..${this.width-1}, 0..${this.height-1}]${i?" - "+i:""}`)}hasOutOfBoundsLockedBlock(){return this.occupiedPositions.some(t=>t.y<0||t.y>=this.height)}log(){console.group("Board"),console.log("meta",{height:this.height,width:this.width,canHoldPiece:this.canHoldPiece}),console.group("Tetrominos");for(const i of this.tetrominos){const o=i.id||"unknown";typeof i.log=="function"?(console.groupCollapsed(`Tetromino ${o}`),i.log(),console.groupEnd()):console.log("  Tetromino (no log):",o)}console.groupEnd(),this.nextTetromino&&(console.group("Next Tetromino"),this.nextTetromino.log?.(),console.groupEnd()),this.activeTetromino&&(console.group("Active Tetromino"),this.activeTetromino.log?.(),console.groupEnd()),console.group("Occupied Positions by row (y)");const t=new Map;for(const i of this.occupiedPositions){const o=t.get(i.y)||[];o.push(i),t.set(i.y,o)}const e=Array.from(t.keys()).sort((i,o)=>i-o);for(const i of e){const o=t.get(i);o.sort((s,l)=>s.x-l.x),console.group(`y=${i}`),o.forEach(s=>{typeof s.log=="function"?s.log():console.log("  Block:",{x:s.x,y:s.y})}),console.groupEnd()}console.groupEnd(),console.groupEnd()}inBounds(t){return t.every(({x:e,y:i})=>e>=0&&e<this.width&&i>=0&&i<this.height)}collision(t){return this.occupiedPositions.some(i=>t.some(o=>i.x===o.x&&i.y===o.y))}_canMove(t){return this._hasCollision(t)?(t==="down"&&this._raiseGameOverIfStackReachesTop(),!1):!0}_hasCollision(t){const e=t==="left"?-1:t==="right"?1:0,i=t==="down"?1:0;return this.activeTetromino.collides(e,i,this.occupiedPositions)}_raiseGameOverIfStackReachesTop(){if(this.activeTetromino.top===0){const t=new Event("gameover");this.element.dispatchEvent(t)}}prepareForLock(t){t.forEach(i=>{this._assertInBounds(i.x,i.y,"when locking tetromino"),this.occupiedPositions.includes(i)||this.occupiedPositions.push(i)}),this.occupiedPositions.sort((i,o)=>o.y-i.y),this._findCompletedLines().length>0&&(this.isAnimating=!0)}_handleTetrominoLocked(t){const e=t;e.target,e.detail.forEach(o=>{this.occupiedPositions.includes(o)||(this._assertInBounds(o.x,o.y,"when locking tetromino"),this.occupiedPositions.push(o))}),this.occupiedPositions.sort((o,s)=>s.y-o.y),this.takeSnapshot();const i=this._findCompletedLines();this.isAnimating&&i.length>0?this._animateLineClear(i):i.length===0&&this.nextTetromino&&this.spawnTetromino(),this.canHoldPiece=!0}_removeCompletedLines(t){const e=new Set;t.forEach(s=>{const l=this.occupiedPositions.filter(c=>c.y===s);this.occupiedPositions=this.occupiedPositions.filter(c=>c.y!==s),l.forEach(c=>{e.add(c.parent),c.parent.blocks=c.parent.blocks.filter(d=>d!==c)})});for(const s of e)s.blocks.length===0&&(this.blockRenderer.clearTetromino(s),this.tetrominos.has(s)&&this.tetrominos.delete(s),s.element.parentNode&&s.element.parentNode.removeChild(s.element));const i=t.length,o=new CustomEvent("linesCompleted",{detail:{linesCompleted:i}});this.element.dispatchEvent(o)}_findCompletedLines(){const t=[];for(let e=0;e<this.height;e++)this.occupiedPositions.filter(o=>o.y===e).length===this.width&&t.push(e);return t.sort()}_dropAllBlocks(){const t=this._groupBlocksByParent(),e=this._calculateTetrominoDropInfo(t);this._dropTetrominosInOptimalOrder(e),this._renderAffectedTetrominoes(),this._updateShadowBlocks()}_renderAffectedTetrominoes(){const t=new Set;for(const e of this.occupiedPositions)e.parent&&e.parent.locked&&t.add(e.parent);for(const e of t)this._updateLockedTetrominoVisuals(e)}_dropTetrominosInOptimalOrder(t){for(const{tetromino:e,blocks:i}of t)this._dropTetrominoAsUnit(e,i),e.collapseBlocks()}_calculateTetrominoDropInfo(t){const e=[];for(const[i,o]of t){const s=this._calculateMaxDrop(i,o);e.push({tetromino:i,blocks:o,maxDrop:s})}return e.sort((i,o)=>o.maxDrop-i.maxDrop),e}_groupBlocksByParent(){const t=new Map;for(const e of this.occupiedPositions)t.has(e.parent)||t.set(e.parent,[]),t.get(e.parent).push(e);return t}_calculateMaxDrop(t,e){let i=this.height;return i=this._calculateBlockDropLimit(e,t,i),i}_calculateBlockDropLimit(t,e,i){for(const o of t){let s=this.height-1-o.y;s=this._findDropDistance(e,o,s),i=Math.min(i,s)}return i}_findDropDistance(t,e,i){for(const o of this.occupiedPositions)o.parent!==t&&o.x===e.x&&o.y>e.y&&(i=Math.min(i,o.y-e.y-1));return i}_dropTetrominoAsUnit(t,e){const i=this._calculateMaxDrop(t,e);for(const o of e)for(let s=0;s<i;s++)o.drop()}_updateLockedTetrominoVisuals(t){this.blockRenderer.updateTetromino(t)}_reuseNextTetromino(){this.previewBoard&&this.previewBoard.previewContainer&&this.previewBoard.previewContainer.contains(this.nextTetromino.element)&&this.previewBoard.previewContainer.removeChild(this.nextTetromino.element);const t=this.nextTetromino;return t.board=this,this.addTetromino(t),t.updatePosition(),t}_cancelAnimation(){this.animationTimeouts.forEach(e=>clearTimeout(e)),this.animationTimeouts=[],this.isAnimating=!1,this.element.querySelectorAll(".line-clearing-flash, .line-clearing-fade").forEach(e=>{e.classList.remove("line-clearing-flash","line-clearing-fade")})}_animateLineClear(t){this.isAnimating=!0;const e=[];t.forEach(s=>{this.occupiedPositions.filter(c=>c.y===s).forEach(c=>{this.element.querySelectorAll(`[data-tetromino-id="${c.parent.id}"]`).forEach(g=>{const x=g,I=parseInt(x.style.top,10);Math.floor(I/this.blockSize)===s&&e.push(x)})})}),e.forEach(s=>s.classList.add("line-clearing-flash"));const i=window.setTimeout(()=>{e.forEach(s=>{s.classList.remove("line-clearing-flash"),s.classList.add("line-clearing-fade")})},ht);this.animationTimeouts.push(i);const o=window.setTimeout(()=>{e.forEach(l=>{l.classList.remove("line-clearing-fade")}),this._removeCompletedLines(t),this._dropAllBlocks(),this.animationTimeouts=this.animationTimeouts.filter(l=>l!==i&&l!==o),this.isAnimating=!1,this.takeSnapshot();const s=this._findCompletedLines();s.length>0?this._animateLineClear(s):this.spawnTetromino()},bt);this.animationTimeouts.push(o)}}const M=class M{constructor(t,e,i,o){this.setDropTimeCallback=i,this.baseDropTime=o,this.currentLevel=1,this.element=t,this.levelElement=e,this.updateLevelDisplay()}setScore(t){this.element.textContent=`Score: ${t}`;const e=this.getLevelForScore(t);if(e!==this.currentLevel){const i=this.currentLevel;this.currentLevel=e,this.updateLevelDisplay();const o=new CustomEvent("levelChange",{detail:{oldLevel:i,newLevel:e},bubbles:!0});this.element.dispatchEvent(o);const s=this.getDropTimeForLevel(e,this.baseDropTime);this.setDropTimeCallback(s)}}getCurrentLevel(){return this.currentLevel}getLevelForScore(t){if(t<M.LEVEL_MULTIPLIER)return 1;let e=1;for(;;){const i=e*(e+1)/2*M.LEVEL_MULTIPLIER;if(t<i)return e;e++}}getDropTimeForLevel(t,e){return Math.round(e*Math.pow(M.SPEED_REDUCTION_FACTOR,t-1))}addEventListener(t,e){this.element.addEventListener(t,e)}updateLevelDisplay(){this.levelElement.textContent=`Level: ${this.currentLevel}`}};M.LEVEL_MULTIPLIER=2e3,M.SPEED_REDUCTION_FACTOR=.8;let Q=M;class Bt{constructor(t){this.currentTetromino=null,this.element=t,this.holdContainer=t.querySelector(".hold-container"),this.holdContainer?this.blockRenderer=new G(this.holdContainer):this.blockRenderer=new G(t),this._applyDimensions()}_applyDimensions(){this.element.style.width=y.HOLD_BOARD_WIDTH+"px",this.holdContainer&&(this.holdContainer.style.width=y.HOLD_CONTAINER_SIZE+"px",this.holdContainer.style.height=y.HOLD_CONTAINER_SIZE+"px")}showHeldTetromino(t){this.currentTetromino&&this.blockRenderer.clearTetromino(this.currentTetromino),this.clearBoard(),this.currentTetromino=t,t.element.parentNode&&t.element.parentNode.removeChild(t.element);const e=(this.element.clientWidth-t.size*2)/2,i=t.board;t.board={getBlockRenderer:()=>this.blockRenderer,getBlockSize:()=>y.BLOCK_SIZE};const o=t.left,s=t.top;t.left=Math.floor(e/t.size),t.top=Math.floor(e/t.size),this.blockRenderer.renderTetromino(t),t.left=o,t.top=s,t.board=i}clearBoard(){if(this.holdContainer)for(;this.holdContainer.firstChild;)this.holdContainer.removeChild(this.holdContainer.firstChild)}getHeldTetromino(){return this.currentTetromino}}const V=new Audio("resources/music/mainMenu.mp3"),W=new Audio("resources/music/fromLevel1.mp3"),q=new Audio("resources/music/fromLevel8.mp3"),F=new Audio("resources/music/fromLevel15.mp3");V.loop=!0;V.preload="auto";W.loop=!0;W.preload="auto";q.loop=!0;q.preload="auto";F.loop=!0;F.preload="auto";const tt={hardDrop:new Audio("resources/sfx/hardDrop.mp3"),levelUp:new Audio("resources/sfx/levelUp.mp3"),lineComplete:new Audio("resources/sfx/lineCompletion.mp3"),tetrisClear:new Audio("resources/sfx/tetrisClear.mp3"),gameOver:new Audio("resources/sfx/gameOver.mp3"),locked:new Audio("resources/sfx/locked.mp3")};Object.values(tt).forEach(a=>{a.preload="auto"});const Et=window.AudioContext||window.webkitAudioContext,L=new Et,_=L.createGain(),C=L.createGain();_.connect(L.destination);C.connect(L.destination);_.gain.value=1;C.gain.value=1;const nt=new Map,rt=new Map;function U(a){if(!nt.has(a)){const t=L.createMediaElementSource(a);t.connect(_),nt.set(a,t)}}function Lt(a){if(!rt.has(a)){const t=L.createMediaElementSource(a);t.connect(C),rt.set(a,t)}}U(V);U(W);U(q);U(F);Object.values(tt).forEach(a=>{Lt(a)});let B=1,P=1;const dt="tetris-muted";function Mt(){const a=localStorage.getItem(dt);return a===null?!0:a==="true"}function St(a){localStorage.setItem(dt,String(a))}class _t{constructor(){this.currentMusic=null,this.currentLevel=1,this.savedMusicVolume=1,this.savedSfxVolume=1,this.muted=Mt(),this.muted?(_.gain.value=0,C.gain.value=0):(this.savedMusicVolume=B,this.savedSfxVolume=P)}isMuted(){return this.muted}toggleMute(){this.muted=!this.muted,St(this.muted),this.muted?(_.gain.value=0,C.gain.value=0):(_.gain.value=B,C.gain.value=P)}setMuted(t){this.muted!==t&&this.toggleMute()}playMainMenuMusic(){this._switchMusic(V)}playGameMusic(t){let e;t>=15?e=F:t>=8?e=q:e=W,this.currentLevel=t,this._switchMusic(e)}handleLevelChange(t){(this.currentLevel<8&&t>=8||this.currentLevel<15&&t>=15)&&this.playGameMusic(t),this.currentLevel=t}stopMusic(){this.currentMusic&&(this.currentMusic.pause(),this.currentMusic.currentTime=0),this.currentMusic=null}_switchMusic(t){this.currentMusic&&this.currentMusic!==t&&(this.currentMusic.pause(),this.currentMusic.currentTime=0),this.currentMusic=t,!this.muted&&B>0&&(this.startMusic(),t.play().catch(e=>{console.log("Error playing music:",e)}))}playSoundEffect(t){const e=tt[t];!this.muted&&P>0&&(e.currentTime=0,this.startMusic(),e.play().catch(i=>{console.log("Error playing sound:",i)}))}startMusic(){L.state==="suspended"&&L.resume()}pauseMusic(){this.currentMusic&&this.currentMusic.pause()}resetMusic(){this.currentMusic&&(this.currentMusic.currentTime=0,this.currentMusic.pause())}initializeControls(){const t=document.getElementById("music-volume"),e=document.getElementById("sfx-volume"),i=document.getElementById("music-min"),o=document.getElementById("music-max"),s=document.getElementById("sfx-min"),l=document.getElementById("sfx-max");t&&t.addEventListener("input",()=>{const c=parseInt(t.value,10)/100,d=B===0;B=c,_.gain.value=B,this.currentMusic&&(d&&B>0&&this.currentMusic.paused?this.currentMusic.play().catch(g=>console.log("Play failed:",g)):B===0&&!this.currentMusic.paused&&this.currentMusic.pause())}),e&&e.addEventListener("input",()=>{P=parseInt(e.value,10)/100,C.gain.value=P}),i&&t&&i.addEventListener("click",()=>{t.value="0",t.dispatchEvent(new Event("input",{bubbles:!0}))}),o&&t&&o.addEventListener("click",()=>{t.value="100",t.dispatchEvent(new Event("input",{bubbles:!0}))}),s&&e&&s.addEventListener("click",()=>{e.value="0",e.dispatchEvent(new Event("input",{bubbles:!0}))}),l&&e&&l.addEventListener("click",()=>{e.value="100",e.dispatchEvent(new Event("input",{bubbles:!0}))})}}class Ct{constructor(){this.items=[],this.availableSeeds=[0,1,2,3,4,5,6]}enqueue(...t){this.items.push(...t)}dequeue(){if(this.items.length>0)return this.items.shift();const t=Math.floor(Math.random()*this.availableSeeds.length);return this.availableSeeds[t]}}const S=class S{constructor(){this.bindings=new Map,this.loadBindings()}loadBindings(){const t=localStorage.getItem(S.STORAGE_KEY),e=t?JSON.parse(t):S.DEFAULT_BINDINGS;this.bindings.clear(),e.forEach(i=>{this.bindings.set(i.key.toLowerCase(),i.action)})}getActionForKey(t){return this.bindings.get(t.toLowerCase())}getCurrentBindings(){return Array.from(this.bindings.entries()).map(([t,e])=>({action:e,key:t}))}rebindKey(t,e){const i=e.toLowerCase();for(const[o]of this.bindings.entries())o.toLowerCase()===i&&this.bindings.delete(o);for(const[o,s]of this.bindings.entries())s===t&&this.bindings.delete(o);this.bindings.set(i,t),this.saveBindings()}saveBindings(){localStorage.setItem(S.STORAGE_KEY,JSON.stringify(this.getCurrentBindings()))}};S.STORAGE_KEY="tetris-key-bindings",S.DEFAULT_BINDINGS=[{action:"moveLeft",key:"ArrowLeft"},{action:"moveRight",key:"ArrowRight"},{action:"rotateClockwise",key:"ArrowUp"},{action:"rotateCounterClockwise",key:"z"},{action:"softDrop",key:"ArrowDown"},{action:"hardDrop",key:" "},{action:"hold",key:"h"}];let j=S;class at{constructor(t){this.container=t,this.eventListeners=new Map,this.initialize()}initialize(){[{selector:"[data-touch-left]",key:"ArrowLeft"},{selector:"[data-touch-right]",key:"ArrowRight"},{selector:"[data-touch-down]",key:"ArrowDown"},{selector:"[data-touch-rotate]",key:"ArrowUp"},{selector:"[data-touch-hard-drop]",key:" "},{selector:"[data-touch-hold]",key:"h"},{selector:"[data-touch-pause]",key:"p"}].forEach(({selector:e,key:i})=>{const o=this.container.querySelector(e);o&&this.attachEventListeners(o,i)})}attachEventListeners(t,e){const i=[],o=l=>{l.preventDefault(),this.dispatchKeyboardEvent(e)},s=l=>{l.preventDefault(),this.dispatchKeyboardEvent(e)};t.addEventListener("click",o),t.addEventListener("touchstart",s),i.push({event:"click",handler:o}),i.push({event:"touchstart",handler:s}),this.eventListeners.set(t,i)}dispatchKeyboardEvent(t){const e=new KeyboardEvent("keydown",{key:t,bubbles:!0,cancelable:!0});document.dispatchEvent(e)}show(){this.container.style.display="block"}hide(){this.container.style.display="none"}destroy(){this.eventListeners.forEach((t,e)=>{t.forEach(({event:i,handler:o})=>{e.removeEventListener(i,o)})}),this.eventListeners.clear()}static isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0}}class E{constructor(t,e,i,o,s,l,c){this.timestamp=t,this.occupiedPositions=e,this.activeTetromino=i,this.nextTetromino=o,this.holdTetromino=s,this.canHoldPiece=l,this.isAnimating=c}static fromBoard(t){const e=Date.now(),i=E._deepCopyBlocks(t),o=E._serializeTetromino(t.getActiveTetromino()),s=E._serializeTetromino(t.nextTetromino),l=E._getHoldTetrominoState(t),c=t.canHoldPiece,d=t.isAnimating||!1;return new E(e,i,o,s,l,c,d)}static _deepCopyBlocks(t){const e=t.occupiedPositions,i=new Map;return e.map(o=>{let s=i.get(o.parent.id);return s||(s={id:o.parent.id},i.set(o.parent.id,s)),new n({x:o.x,y:o.y,parent:s})})}static _serializeTetromino(t){return t?{seed:t.seed??0,left:t.left,top:t.top,rotation:t.rotation,locked:t.locked,id:t.id,blocks:t.getBlocks().map(e=>({x:e.x,y:e.y}))}:null}static _getHoldTetrominoState(t){const e=t.holdBoard;if(!e)return null;const i=e.getHeldTetromino();return E._serializeTetromino(i)}getMetadata(){return{timestamp:this.timestamp,formattedTime:this._formatTimestamp(),occupiedBlockCount:this.occupiedPositions.length,hasActiveTetromino:this.activeTetromino!==null,hasNextTetromino:this.nextTetromino!==null,hasHoldTetromino:this.holdTetromino!==null,canHoldPiece:this.canHoldPiece,isAnimating:this.isAnimating}}_formatTimestamp(){const t=new Date(this.timestamp),e=t.getHours().toString().padStart(2,"0"),i=t.getMinutes().toString().padStart(2,"0"),o=t.getSeconds().toString().padStart(2,"0"),s=t.getMilliseconds().toString().padStart(3,"0");return`${e}:${i}:${o}.${s}`}toJSON(){return{timestamp:this.timestamp,occupiedPositions:this.occupiedPositions.map(t=>({x:t.x,y:t.y,parentId:t.parent.id})),activeTetromino:this.activeTetromino,nextTetromino:this.nextTetromino,holdTetromino:this.holdTetromino,canHoldPiece:this.canHoldPiece,isAnimating:this.isAnimating}}restoreTetromino(t,e){const i=J.createNew(t.left,e,t.seed);i.top=t.top,i.rotation=t.rotation,i.locked=t.locked,i.id=t.id;for(let o=0;o<t.rotation;o++)i.rotate(1);return i.updatePosition(),i}getRestoredState(t){const e=this.restoreTetromino(this.activeTetromino,t),i=this.nextTetromino?this.restoreTetromino(this.nextTetromino,null):null,o=new Map,s=[];for(const c of this.occupiedPositions){const d=c.parent.id;let g=o.get(d);if(!g){const x={seed:0,left:0,top:0,rotation:0,locked:!0,id:d,blocks:[]};g=this.restoreTetromino(x,t),g.blocks=[],o.set(d,g),s.push(g)}}return{occupiedPositions:this.occupiedPositions.map(c=>{const d=o.get(c.parent.id),g=new n({x:c.x,y:c.y,parent:d});return d.blocks.push(g),g}),activeTetromino:e,nextTetromino:i,lockedTetrominos:s,canHoldPiece:this.canHoldPiece}}}class It{constructor(t=50){this.snapshots=[],this.currentIndex=0,this.maxSize=t}addSnapshot(t){this.snapshots.length<this.maxSize?(this.snapshots.push(t),this.currentIndex=this.snapshots.length-1):(this.snapshots.shift(),this.snapshots.push(t),this.currentIndex=this.snapshots.length-1)}takeSnapshot(t){const e=E.fromBoard(t);this.addSnapshot(e)}getSnapshot(t){return t<0||t>=this.snapshots.length?null:this.snapshots[t]}getLatestSnapshot(){return this.snapshots.length===0?null:this.snapshots[this.snapshots.length-1]}getSnapshotCount(){return this.snapshots.length}getAllSnapshots(){return[...this.snapshots]}clear(){this.snapshots=[],this.currentIndex=0}exportHistory(){return JSON.stringify(this.snapshots.map(t=>t.toJSON()),null,2)}}const Dt={},ct=750,At="tick";let z,R=null;const lt=Dt?.VITE_DEBUG==="true";Ot();function Ot(){z=new j;const a=new _t,t={tetrominoDropTime:750,gameRunning:!1,isPaused:!1,board:null,tickIntervalId:null,tetrominoSeedQueue:new Ct,currentScore:0,scoreBoard:null};a.initializeControls(),c(),a.playMainMenuMusic(),e(),x(),window.SizingConfig=y,window.BUILD_VERSION="2026-01-14.9",I(),D(),g(),o(),d(),console.log(`Build Version: ${window.BUILD_VERSION}`);function e(){const r=document.getElementById("touch-controls");if(!r)return;const h=new at(r);at.isTouchDevice()?h.show():h.hide()}if(lt){console.log("[DEBUG MODE] Board history tracking enabled");const r=document.getElementById("debug-indicator");r&&(r.style.display="block"),i()}function i(){window.getBoardHistory=function(){if(!t.board)return console.log("No board available"),[];const r=t.board.getHistoryManager();if(!r)return console.log("History manager not initialized"),[];const h=r.getAllSnapshots();return console.log(`Found ${h.length} snapshots in history`),h},window.restoreSnapshot=function(r){if(!t.board){console.log("No board available");return}const h=t.board.getHistoryManager();if(!h){console.log("History manager not initialized");return}const u=h.getSnapshot(r);if(!u){console.log(`No snapshot found at index ${r}`);return}console.log(`Restoring snapshot ${r} from ${u.getMetadata().formattedTime}`),t.board.restoreFromSnapshot(u),console.log("Snapshot restored successfully")},window.exportBoardHistory=function(){if(!t.board)return JSON.stringify({error:"No board available"});const r=t.board.getHistoryManager();return r?r.exportHistory():JSON.stringify({error:"History manager not initialized"})}}function o(){const r=document.querySelector("[data-settings-button]"),h=document.querySelector("[data-key-rebind-menu]"),u=document.querySelector("[data-settings-close]"),p=document.querySelector("[data-rebind-prompt]");if(!r||!h||!u||!p)return;r.addEventListener("click",()=>{h.setAttribute("style","display: flex"),l()}),u.addEventListener("click",()=>{h.setAttribute("style","display: none"),p.style.display="none",R=null}),document.querySelectorAll("[data-action]").forEach(f=>{f.addEventListener("click",v=>{const k=v.currentTarget;if(!k)return;R=k;const w=k.dataset.action;w&&(p.textContent=`Press a key to bind ${w.replace(/([A-Z])/g," $1").toLowerCase()}`,p.style.display="block",document.body.focus())})}),document.addEventListener("keydown",s),l()}function s(r){if(!R)return;const h=R.dataset.action;if(!h||r.key==="Tab"||r.key==="Escape")return;r.preventDefault(),z.rebindKey(h,r.key),l();const u=document.querySelector("[data-rebind-prompt]");u&&(u.style.display="none"),R=null}function l(){z.getCurrentBindings().forEach(h=>{const u=document.querySelector(`[data-current-${h.action}-bind]`);u&&(u.textContent=h.key)})}function c(){const r=document.getElementById("mute-toggle-desktop"),h=document.getElementById("mute-toggle-mobile"),u=f=>{const v=a.isMuted();f.setAttribute("data-muted",String(v));const k=f.querySelector(".mute-icon");k&&(k.textContent=v?"ðŸ”‡":"ðŸ”Š");const w=f.querySelector(".mute-label");w&&(w.textContent=v?"Unmute All":"Mute All")},p=()=>{r&&u(r),h&&u(h)},m=()=>{a.toggleMute(),p()};r&&(u(r),r.addEventListener("click",m)),h&&(u(h),h.addEventListener("click",m))}function d(){const r=document.getElementById("mobile-audio-settings-button"),h=document.getElementById("mobile-audio-modal"),u=document.getElementById("mobile-audio-close"),p=document.getElementById("mobile-music-volume"),m=document.getElementById("mobile-sfx-volume"),f=document.getElementById("music-volume"),v=document.getElementById("sfx-volume");if(!r||!h||!u)return;r.addEventListener("click",()=>{t.gameRunning&&!t.isPaused&&Z(),h.style.display="flex"}),u.addEventListener("click",()=>{h.style.display="none"}),p&&f&&p.addEventListener("input",()=>{f.value=p.value,f.dispatchEvent(new Event("input"))}),m&&v&&m.addEventListener("input",()=>{v.value=m.value,v.dispatchEvent(new Event("input"))});const k=document.getElementById("mobile-music-min"),w=document.getElementById("mobile-music-max"),N=document.getElementById("mobile-sfx-min"),K=document.getElementById("mobile-sfx-max");k&&p&&f&&k.addEventListener("click",()=>{p.value="0",f.value="0",f.dispatchEvent(new Event("input"))}),w&&p&&f&&w.addEventListener("click",()=>{p.value="100",f.value="100",f.dispatchEvent(new Event("input"))}),N&&m&&v&&N.addEventListener("click",()=>{m.value="0",v.value="0",v.dispatchEvent(new Event("input"))}),K&&m&&v&&K.addEventListener("click",()=>{m.value="100",v.value="100",v.dispatchEvent(new Event("input"))})}function g(){const r=document.getElementById("start-button-desktop"),h=document.getElementById("start-button"),u=()=>{if(t.gameRunning){et();return}H()},p=()=>{if(!t.gameRunning){H();return}Z()};r&&r.addEventListener("click",u),h&&h.addEventListener("click",p);const m=document.getElementById("reset-button-overlay");m&&m.addEventListener("click",()=>{et()})}function x(){window.setTetrominoDropTime=function(r){A(r)},window.pushTetrominoSeed=function(...r){t.tetrominoSeedQueue.enqueue(...r)},window.logBoard=function(){t.board&&typeof t.board.log=="function"?t.board.log():console.log("No board available to log.")}}function I(){document.addEventListener("keydown",r=>{(r.key.toLowerCase()==="p"||r.key==="Escape")&&Z()})}function D(){const r=document.getElementById("game-board");r&&r.addEventListener("gameover",()=>{X(),a.playSoundEffect("gameOver"),a.stopMusic();const h=document.createElement("div");h.id="game-over",h.className="game-over";const u=document.getElementById("game-board");u&&u.appendChild(h)})}function A(r){t.tetrominoDropTime=r,it()}function H(){t.gameRunning=!0,t.currentScore=0,a.playGameMusic(1),h(),r(),ut(),it();function r(){const p=document.getElementById("start-button"),m=document.getElementById("start-button-desktop");if(p){const f=p.querySelector(".touch-label");f&&(f.textContent="Pause"),p.blur()}m&&(m.textContent="Reset Game",m.blur())}function h(){const p=u();f(),m();function m(){t.scoreBoard=new Q(document.getElementById("score-board"),document.getElementById("level-board"),A,ct),t.scoreBoard.setScore(t.currentScore),t.scoreBoard.addEventListener("levelChange",v=>{const k=v,{newLevel:w}=k.detail;a.playSoundEffect("levelUp"),a.handleLevelChange(w)})}function f(){const v=document.querySelector("#hold-board .hold-container"),k=new Bt(v),w=lt?new It(50):null;t.board=new Tt(20,11,document.getElementById("game-board"),p,t.tetrominoSeedQueue,k,z,a,y.BLOCK_SIZE,w),t.board.registerEventListener("linesCompleted",N),t.board.registerEventListener("scoreEvent",K);function N(Y){const O=Y.detail.linesCompleted;t.currentScore+=O*(O+1)*50,O>=4?a.playSoundEffect("tetrisClear"):a.playSoundEffect("lineComplete"),t.scoreBoard.setScore(t.currentScore)}function K(Y){const ot=Y,{points:O}=ot.detail;t.currentScore+=O,t.scoreBoard.setScore(t.currentScore)}}}function u(){return new pt(document.getElementById("next-board"))}}function Z(){if(!t.gameRunning||t.board&&t.board.isAnimating)return;t.isPaused=!t.isPaused,t.board&&t.board.pauseGame();const r=document.getElementById("pause-overlay");r&&(r.style.display=t.isPaused?"block":"none");const h=document.getElementById("start-button");if(h){const u=h.querySelector(".touch-label");u&&(u.textContent=t.isPaused?"Resume":"Pause")}}function et(){X(),t.gameRunning=!1,t.isPaused=!1,t.currentScore=0,t.tetrominoDropTime=ct;const r=document.getElementById("game-over");r&&r.remove();const h=document.getElementById("pause-overlay");h&&(h.style.display="none");const u=document.getElementById("start-button"),p=document.getElementById("start-button-desktop");if(u){const v=u.querySelector(".touch-label");v&&(v.textContent="Start")}p&&(p.textContent="Start Game"),t.scoreBoard&&t.scoreBoard.setScore(0),t.board&&(t.board.reset(),t.board.canHoldPiece=!0);const m=document.querySelector("#preview-container");m&&(m.innerHTML="");const f=document.querySelector("#hold-board .hold-container");f&&(f.innerHTML=""),a.playMainMenuMusic()}function it(){X(),t.tickIntervalId=setInterval(()=>{t.isPaused||document.dispatchEvent(new Event(At))},t.tetrominoDropTime)}function X(){t.tickIntervalId&&(clearInterval(t.tickIntervalId),t.tickIntervalId=null)}function ut(){t.board&&t.board.spawnTetromino()}}
