(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(o){if(o.ep)return;o.ep=!0;const s=e(o);fetch(o.href,s)}})();class j{constructor(t){this.element=t,this.previewContainer=t.querySelector("#preview-container"),this.size=24}showNextTetromino(t){this.previewContainer.innerHTML="",t.element.style.position="absolute",t.element.style.left="36px",t.element.style.top="36px",this.previewContainer.appendChild(t.element)}}class n{constructor({x:t,y:e,parent:i}){this.x=t,this.y=e,this.parent=i}drop(){this.y++}delete(){this.parent.removeBlock(this)}log(){console.log("  Block ->",{x:this.x,y:this.y,tetrominoId:this.parent?.id})}}const L=class L{constructor(t,e){this.paused=!1,this.blocks=[],this.id=(L.nextId++).toString(),this.pivot=new n({x:t,y:0,parent:this}),this.size=24,this.board=e,this.locked=!1,this.rotation=0,this.element=this._createElement(),this.blocks=this.getBlocks(),this._renderBlocks(),this.board&&this.board.addTetromino(this)}pause(){this.paused=!this.paused}collapseBlocks(){for(const t of this.blocks){let e=this.blocks.filter(o=>o.x===t.x&&o.y>t.y),i=Math.min(...e.map(o=>o.y));e.length>0&&i-1>t.y&&(t.drop(),this.collapseBlocks())}}dropByOne(){this.blocks.forEach(t=>t.drop())}get left(){return this.pivot.x}set left(t){this.pivot.x=t}get top(){return this.pivot.y}set top(t){this.pivot.y=t}reset(){this.left=Math.floor((this.board?.width||10)/2),this.top=0,this.rotation=0,this.locked=!1,this.paused=!1,this.updatePosition(),this.updateBlocks()}createBlocks(){this.blocks=this.getBlocks()}removeBlock(t){this.blocks=this.blocks.filter(e=>e!==t),this.updateBlocks(),this.blocks.length===0&&this.board&&this.board.removeTetromino(this)}_createElement(){return this._createDiv(this.getClassName())}collides(t,e,i){return this.getBlocks().map(({x:s,y:a})=>({x:s+t,y:a+e})).some(({x:s,y:a})=>i.some(({x:h,y:p})=>h===s&&p===a))}_createDiv(t,e=0,i=0,o=this.size){const s=document.createElement("div");return s.className=t,s.style.width=o+"px",s.style.height=o+"px",s.style.position="absolute",s.style.left=e*o+"px",s.style.top=i*o+"px",s.setAttribute("data-tetromino-id",this.id),s}move(t){const e=this.board;if(!e||this.locked)return;e.moveTetromino(this,t)&&t==="down"&&this._dispatchScoreEvent(10)}drop(){if(!this.board||this.locked)return;let t=0;for(;this.board.moveTetromino(this,"down");)t++;if(t>0){this._dispatchScoreEvent(t*15);const e=new Event("hardDrop");this.element.dispatchEvent(e)}this.lock()}_dispatchScoreEvent(t){const e=new CustomEvent("scoreEvent",{detail:{points:t},bubbles:!0});this.element.dispatchEvent(e)}addEventListener(t,e){this.element.addEventListener(t,e)}updatePosition(){this.element.style.top=this.top*this.size+"px",this.element.style.left=this.left*this.size+"px",this.board&&typeof this.board.getBlockRenderer=="function"&&this.board.getBlockRenderer().updateTetromino(this)}lock(){if(this.locked)return;this.stopListening(),this.blocks=this.getBlocks(),this.locked=!0,this._dispatchScoreEvent(5);const t=new CustomEvent("locked",{detail:this.getBlocks()});this.element.dispatchEvent(t)}_setupKeyboardListener(t){this.keyboardListener=e=>{if(this.locked||!this.board||this.paused)return;const i=t.getActionForKey(e.key);if(i)switch(i){case"moveLeft":this.move("left");break;case"moveRight":this.move("right");break;case"softDrop":this.move("down");break;case"hardDrop":e.preventDefault&&e.preventDefault(),this.drop();break;case"rotateClockwise":this.rotate();break;case"rotateCounterClockwise":this.rotate(-1);break;case"hold":this.board&&this.board.hold();break}},document.addEventListener("keydown",this.keyboardListener)}_removeKeyboardListener(){this.keyboardListener&&(document.removeEventListener("keydown",this.keyboardListener),this.keyboardListener=void 0)}startFalling(){!this.board||this.locked||(this.fallListener=()=>{!this.locked&&this.board&&(this.board.moveTetromino(this,"down")||this.lock())},document.addEventListener("tick",this.fallListener))}stopListening(){document.removeEventListener("tick",this.fallListener),this.deactivateKeyboardControl()}activateKeyboardControl(t){this._removeKeyboardListener(),this._setupKeyboardListener(t)}deactivateKeyboardControl(){this._removeKeyboardListener()}rotate(t=1){const e=this.board,i=this.rotation;this.rotation+=t;const o=this.getBlocks();if(!e.inBounds(o)||e.collision(o)){this.rotation=i;return}this.blocks=o,this.updateBlocks()}updateBlocks(){if(this.blocks=this.getBlocks(),this.board&&typeof this.board.getBlockRenderer=="function")this.board.getBlockRenderer().updateTetromino(this);else{for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild);this._renderBlocks()}}_renderBlocks(){this.blocks.forEach(({x:t,y:e})=>{const i=this._createDiv("block",t-this.left,e-this.top);this.element.appendChild(i)})}log(){console.log(" Tetromino ->",{id:this.id,left:this.left,top:this.top,locked:this.locked}),this.blocks&&this.blocks.length>0&&(console.log("  Blocks:"),this.blocks.forEach(t=>{t.log?t.log():console.log("    ",{x:t.x,y:t.y})}))}};L.nextId=1;let m=L;class J extends m{getClassName(){return"tetromino tetromino-t"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%4){case 0:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this})];break;case 1:t=[this.pivot,new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this})];break;case 2:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this})];break;default:t=[this.pivot,new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y,parent:this})]}return this.blocks=t,t}}class W extends m{getClassName(){return"tetromino tetromino-i"}getBlocks(){if(this.locked)return this.blocks;let t;return this.rotation%2===0?t=[new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),this.pivot,new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+2,y:this.pivot.y,parent:this})]:t=[new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),this.pivot,new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+2,parent:this})],this.blocks=t,t}}class Z extends m{getClassName(){return"tetromino tetromino-o"}createBlocks(){const t=[new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),this.pivot];this.blocks=t}getBlocks(){if(this.locked)return this.blocks;const t=[new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),this.pivot];return this.blocks=t,t}rotate(){}}class X extends m{getClassName(){return"tetromino tetromino-j"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%4){case 0:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this})];break;case 1:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y-1,parent:this})];break;case 2:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y-1,parent:this})];break;default:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y+1,parent:this})]}return this.blocks=t,t}}class tt extends m{getClassName(){return"tetromino tetromino-l"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%4){case 0:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y+1,parent:this})];break;case 1:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this})];break;case 2:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y-1,parent:this})];break;default:t=[new n({x:this.pivot.x,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y-1,parent:this})]}return this.blocks=t,t}}class et extends m{getClassName(){return"tetromino tetromino-z"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%2){case 0:t=[this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x+1,y:this.pivot.y+1,parent:this})];break;default:t=[new n({x:this.pivot.x,y:this.pivot.y-1,parent:this}),this.pivot,new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y+1,parent:this})]}return this.blocks=t,t}}class it extends m{getClassName(){return"tetromino tetromino-s"}getBlocks(){if(this.locked)return this.blocks;let t;switch(this.rotation%2){case 0:t=[this.pivot,new n({x:this.pivot.x+1,y:this.pivot.y,parent:this}),new n({x:this.pivot.x,y:this.pivot.y+1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y+1,parent:this})];break;default:t=[new n({x:this.pivot.x-1,y:this.pivot.y-1,parent:this}),new n({x:this.pivot.x-1,y:this.pivot.y,parent:this}),this.pivot,new n({x:this.pivot.x,y:this.pivot.y+1,parent:this})]}return this.blocks=t,t}}class F extends m{getClassName(){return"tetromino"}getBlocks(){if(this.locked)return this.blocks;const t=[this.pivot];return this.blocks=t,t}}class K{static createNew(t,e,i){switch(i){case 0:return new J(t,e);case 1:return new W(t,e);case 2:return new Z(t,e);case 3:return new X(t,e);case 4:return new tt(t,e);case 5:return new et(t,e);case 6:return new it(t,e);case 1337:return new F(t,e);default:return new F(t,e)}}}class ot{constructor(t){this.coordinateBlocks=new Map,this.renderingMode="container",this.board=t}setRenderingMode(t){this.renderingMode=t}getCurrentRenderingMode(){return window.USE_COORDINATE_RENDERING===!0?"coordinate":this.renderingMode}renderTetromino(t){this.getCurrentRenderingMode()==="coordinate"?this.renderCoordinateBlocks(t):this.renderContainerBlocks(t)}clearTetromino(t){this.getCurrentRenderingMode()==="coordinate"&&this.clearCoordinateBlocks(t)}renderCoordinateBlocks(t){this.clearCoordinateBlocks(t),t.element.style.display="none",t.getBlocks().forEach(e=>{const i=this.createCoordinateBlock(e,t),o=`${t.id}-${e.x}-${e.y}`;this.coordinateBlocks.set(o,i),this.board.appendChild(i)})}renderContainerBlocks(t){for(t.element.style.display="";t.element.firstChild;)t.element.removeChild(t.element.firstChild);const e=t.getBlocks();if(t.locked){const i=Math.min(...e.map(s=>s.x)),o=Math.min(...e.map(s=>s.y));t.element.style.left=i*t.size+"px",t.element.style.top=o*t.size+"px",e.forEach(({x:s,y:a})=>{const h=this.createContainerBlock(s-i,a-o,t);t.element.appendChild(h)})}else e.forEach(({x:i,y:o})=>{const s=this.createContainerBlock(i-t.left,o-t.top,t);t.element.appendChild(s)})}clearCoordinateBlocks(t){const e=t.id,i=[];this.coordinateBlocks.forEach((o,s)=>{s.startsWith(`${e}-`)&&(o.remove(),i.push(s))}),i.forEach(o=>this.coordinateBlocks.delete(o))}createCoordinateBlock(t,e){const i=document.createElement("div");return i.className=`coordinate-block ${e.getClassName()}-coordinate-block`,i.style.position="absolute",i.style.width="24px",i.style.height="24px",i.style.left=`${t.x*24}px`,i.style.top=`${t.y*24}px`,i.setAttribute("data-tetromino-id",e.id),i}createContainerBlock(t,e,i){const o=document.createElement("div");return o.className="block",o.style.width=i.size+"px",o.style.height=i.size+"px",o.style.position="absolute",o.style.left=t*i.size+"px",o.style.top=e*i.size+"px",o.setAttribute("data-tetromino-id",i.id),o}updateTetromino(t){this.renderTetromino(t)}}class st{constructor(t,e,i,o,s,a=null,h=null,p=null){this.nextTetromino=null,this.occupiedPositions=[],this.coordinateBlocks=new Map,this.canHoldPiece=!0,this.keyBindingManager=null,this.audioManager=null,this.height=t,this.width=e,this.element=i,this.previewBoard=o,this.holdBoard=a,this.tetrominos=new Set,this.nextTetromino=null,this.tetrominoSeedQueue=s,this.keyBindingManager=h,this.audioManager=p,this.blockRenderer=new ot(i)}reset(){this.tetrominos.clear(),this.occupiedPositions=[],this.coordinateBlocks.clear(),this.nextTetromino=null,this.activeTetromino&&this.activeTetromino.stopListening(),this.activeTetromino=null,this.element.innerHTML=""}registerEventListener(t,e){this.element.addEventListener(t,e)}pauseGame(){this.activeTetromino.pause()}hold(){if(!this.holdBoard||!this.canHoldPiece||this.activeTetromino.locked)return;const{storedTetromino:t,currentTetromino:e}=this._resetActiveTetromino();t?this._swap(e,t):this._moveToHoldBoard(e)}_moveToHoldBoard(t){this.holdBoard.showHeldTetromino(t),t.board=null,this.spawnTetromino()}_swap(t,e){this.holdBoard.showHeldTetromino(t),t.board=null,this.addTetromino(e),e.reset(),e.startFalling(),this.keyBindingManager&&this.activeTetromino.activateKeyboardControl(this.keyBindingManager)}_resetActiveTetromino(){this.activeTetromino.stopListening();const t=this.activeTetromino,e=this.holdBoard.getHeldTetromino();return this.tetrominos.delete(t),this.canHoldPiece=!1,{storedTetromino:e,currentTetromino:t}}addTetromino(t){this.tetrominos.add(t),this.element.appendChild(t.element),this.activeTetromino=t,t.board=this,t.addEventListener("locked",this._handleTetrominoLocked.bind(this)),this.blockRenderer.renderTetromino(t)}removeTetromino(t){this.tetrominos.has(t)&&(this.occupiedPositions.some(e=>e.parent.id===t.id)&&(console.error("Removing tetromino with id "+t.id+" with blocks still in occupiedPositions:"),t.log(),this.log(),this.occupiedPositions=this.occupiedPositions.filter(e=>e.parent.id!==t.id)),this.tetrominos.delete(t))}moveTetromino(t,e){let i=0,o=0;return e==="left"&&(i=-1),e==="right"&&(i=1),e==="down"&&(o=1),!t.getBlocks().map(({x:h,y:p})=>({x:h+i,y:p+o})).every(({x:h,y:p})=>h>=0&&h<this.width&&p>=0&&p<this.height)||!this._canMove(e)?!1:(e==="left"&&t.left--,e==="right"&&t.left++,e==="down"&&t.top++,t.updatePosition(),!0)}spawnTetromino(){let t;const e=Math.floor(this.width/2);return this.nextTetromino?t=this._reuseNextTetromino():t=this._createNewTetromino(e),this._configureTetrominoListeners(t),t.startFalling(),this._prepareNextTetromino(e),t}_prepareNextTetromino(t){this.nextTetromino=K.createNew(t,null,this.tetrominoSeedQueue.dequeue()),this.nextTetromino.updatePosition(),this.previewBoard&&this.previewBoard.showNextTetromino&&this.previewBoard.showNextTetromino(this.nextTetromino)}_configureTetrominoListeners(t){t.addEventListener("locked",()=>{this.spawnTetromino(),this.audioManager&&this.audioManager.playSoundEffect("locked")}),t.addEventListener("hardDrop",()=>{this.audioManager&&this.audioManager.playSoundEffect("hardDrop")}),this.keyBindingManager&&t.activateKeyboardControl(this.keyBindingManager)}_createNewTetromino(t){const e=K.createNew(t,this,this.tetrominoSeedQueue.dequeue());return e.updatePosition(),e}getActiveTetromino(){return this.activeTetromino}getBlockRenderer(){return this.blockRenderer}getHeight(){return this.height}hasOutOfBoundsLockedBlock(){return this.occupiedPositions.some(t=>t.y<0||t.y>=this.height)}log(){console.group("Board"),console.log("meta",{height:this.height,width:this.width,canHoldPiece:this.canHoldPiece}),console.group("Tetrominos");for(const i of this.tetrominos){const o=i.id||"unknown";typeof i.log=="function"?(console.groupCollapsed(`Tetromino ${o}`),i.log(),console.groupEnd()):console.log("  Tetromino (no log):",o)}console.groupEnd(),this.nextTetromino&&(console.group("Next Tetromino"),this.nextTetromino.log?.(),console.groupEnd()),this.activeTetromino&&(console.group("Active Tetromino"),this.activeTetromino.log?.(),console.groupEnd()),console.group("Occupied Positions by row (y)");const t=new Map;for(const i of this.occupiedPositions){const o=t.get(i.y)||[];o.push(i),t.set(i.y,o)}const e=Array.from(t.keys()).sort((i,o)=>i-o);for(const i of e){const o=t.get(i);o.sort((s,a)=>s.x-a.x),console.group(`y=${i}`),o.forEach(s=>{typeof s.log=="function"?s.log():console.log("  Block:",{x:s.x,y:s.y})}),console.groupEnd()}console.groupEnd(),console.groupEnd()}inBounds(t){return t.every(({x:e,y:i})=>e>=0&&e<this.width&&i>=0&&i<this.height)}collision(t){return this.occupiedPositions.some(i=>t.some(o=>i.x===o.x&&i.y===o.y))}_canMove(t){return this._hasCollision(t)?(t==="down"&&this._raiseGameOverIfStackReachesTop(),!1):!0}_hasCollision(t){const e=t==="left"?-1:t==="right"?1:0,i=t==="down"?1:0;return this.activeTetromino.collides(e,i,this.occupiedPositions)}_raiseGameOverIfStackReachesTop(){if(this.activeTetromino.top===0){const t=new Event("gameover");this.element.dispatchEvent(t)}}_handleTetrominoLocked(t){t.detail.forEach(i=>{this.occupiedPositions.push(i)}),this.occupiedPositions.sort((i,o)=>o.y-i.y),this._checkForCompletedLines(),this.canHoldPiece=!0}_checkForCompletedLines(){const t=this._findCompletedLines();t.length>0&&(this._removeCompletedLines(t),this._dropAllBlocks(),this._checkForCompletedLines())}_removeCompletedLines(t){t.forEach(o=>{this.occupiedPositions.filter(s=>s.y===o).forEach(s=>s.delete()),this.occupiedPositions=this.occupiedPositions.filter(s=>s.y!==o)});let e=t.length;const i=new CustomEvent("linesCompleted",{detail:{linesCompleted:e}});this.element.dispatchEvent(i)}_findCompletedLines(){const t=[];for(let e=0;e<this.height;e++)this.occupiedPositions.filter(o=>o.y===e).length===this.width&&t.push(e);return t.sort()}_dropAllBlocks(){const t=this._groupBlocksByParent(),e=this._calculateTetrominoDropInfo(t);this._dropTetrominosInOptimalOrder(e),this._renderAffectedTetrominoes()}_renderAffectedTetrominoes(){const t=new Set;for(const e of this.occupiedPositions)e.parent&&e.parent.locked&&t.add(e.parent);for(const e of t)this._updateLockedTetrominoVisuals(e)}_dropTetrominosInOptimalOrder(t){for(const{tetromino:e,blocks:i}of t)this._dropTetrominoAsUnit(e,i),e.collapseBlocks()}_calculateTetrominoDropInfo(t){const e=[];for(const[i,o]of t){const s=this._calculateMaxDrop(i,o);e.push({tetromino:i,blocks:o,maxDrop:s})}return e.sort((i,o)=>o.maxDrop-i.maxDrop),e}_groupBlocksByParent(){const t=new Map;for(const e of this.occupiedPositions)t.has(e.parent)||t.set(e.parent,[]),t.get(e.parent).push(e);return t}_calculateMaxDrop(t,e){let i=this.height;return i=this._calculateBlockDropLimit(e,t,i),i}_calculateBlockDropLimit(t,e,i){for(const o of t){let s=this.height-1-o.y;s=this._findDropDistance(e,o,s),i=Math.min(i,s)}return i}_findDropDistance(t,e,i){for(const o of this.occupiedPositions)o.parent!==t&&o.x===e.x&&o.y>e.y&&(i=Math.min(i,o.y-e.y-1));return i}_dropTetrominoAsUnit(t,e){const i=this._calculateMaxDrop(t,e);for(const o of e)for(let s=0;s<i;s++)o.drop()}_updateLockedTetrominoVisuals(t){this.blockRenderer.updateTetromino(t)}_reuseNextTetromino(){this.previewBoard&&this.previewBoard.previewContainer.contains(this.nextTetromino.element)&&this.previewBoard.previewContainer.removeChild(this.nextTetromino.element);const t=this.nextTetromino;return t.board=this,this.addTetromino(t),t.updatePosition(),t}isCoordinateRenderingEnabled(){return window.USE_COORDINATE_RENDERING===!0}renderTetrominoCoordinates(t){this.blockRenderer.updateTetromino(t)}clearTetrominoCoordinates(t){this.blockRenderer.clearTetromino(t)}}const y=class y{constructor(t,e,i,o){this.setDropTimeCallback=i,this.baseDropTime=o,this.currentLevel=1,this.element=t,this.levelElement=e,this.updateLevelDisplay()}setScore(t){this.element.textContent=`Score: ${t}`;const e=this.getLevelForScore(t);if(e!==this.currentLevel){const i=this.currentLevel;this.currentLevel=e,this.updateLevelDisplay();const o=new CustomEvent("levelChange",{detail:{oldLevel:i,newLevel:e},bubbles:!0});this.element.dispatchEvent(o);const s=this.getDropTimeForLevel(e,this.baseDropTime);this.setDropTimeCallback(s)}}getCurrentLevel(){return this.currentLevel}getLevelForScore(t){if(t<y.LEVEL_MULTIPLIER)return 1;let e=1;for(;;){const i=e*(e+1)/2*y.LEVEL_MULTIPLIER;if(t<i)return e;e++}}getDropTimeForLevel(t,e){return Math.round(e*Math.pow(y.SPEED_REDUCTION_FACTOR,t-1))}addEventListener(t,e){this.element.addEventListener(t,e)}updateLevelDisplay(){this.levelElement.textContent=`Level: ${this.currentLevel}`}};y.LEVEL_MULTIPLIER=2e3,y.SPEED_REDUCTION_FACTOR=.8;let I=y;class nt{constructor(t){this.currentTetromino=null,this.element=t}showHeldTetromino(t){this.clearBoard(),this.currentTetromino=t,t.element.parentNode&&t.element.parentNode.removeChild(t.element);const e=30;t.element.style.position="absolute",t.element.style.left=`${(this.element.clientWidth-e*2)/2}px`,t.element.style.top=`${(this.element.clientHeight-e*2)/2}px`,this.element.appendChild(t.element)}clearBoard(){for(;this.element.firstChild;)this.element.removeChild(this.element.firstChild)}getHeldTetromino(){return this.currentTetromino}}const P=new Audio("resources/music/mainMenu.mp3"),A=new Audio("resources/music/fromLevel1.mp3"),N=new Audio("resources/music/fromLevel8.mp3"),R=new Audio("resources/music/fromLevel15.mp3");P.loop=!0;P.preload="auto";A.loop=!0;A.preload="auto";N.loop=!0;N.preload="auto";R.loop=!0;R.preload="auto";const C={hardDrop:new Audio("resources/sfx/hardDrop.mp3"),levelUp:new Audio("resources/sfx/levelUp.mp3"),lineComplete:new Audio("resources/sfx/lineCompletion.mp3"),tetrisClear:new Audio("resources/sfx/tetrisClear.mp3"),gameOver:new Audio("resources/sfx/gameOver.mp3"),locked:new Audio("resources/sfx/locked.mp3")};Object.values(C).forEach(c=>{c.preload="auto"});const rt=window.AudioContext||window.webkitAudioContext,z=new rt;let k=1,E=1;class ct{constructor(){this.currentMusic=null,this.currentLevel=1}playMainMenuMusic(){this._switchMusic(P)}playGameMusic(t){let e;t>=15?e=R:t>=8?e=N:e=A,this.currentLevel=t,this._switchMusic(e)}handleLevelChange(t){(this.currentLevel<8&&t>=8||this.currentLevel<15&&t>=15)&&this.playGameMusic(t),this.currentLevel=t}stopMusic(){this.currentMusic&&(this.currentMusic.pause(),this.currentMusic.currentTime=0),this.currentMusic=null}_switchMusic(t){this.currentMusic&&this.currentMusic!==t&&(this.currentMusic.pause(),this.currentMusic.currentTime=0),this.currentMusic=t,k>0&&(t.volume=k,this.startMusic(),t.play().catch(e=>{console.log("Error playing music:",e)}))}playSoundEffect(t){const e=C[t];E>0&&(e.currentTime=0,e.volume=E,this.startMusic(),e.play().catch(i=>{console.log("Error playing sound:",i)}))}startMusic(){z.state==="suspended"&&z.resume()}pauseMusic(){this.currentMusic&&this.currentMusic.pause()}resetMusic(){this.currentMusic&&(this.currentMusic.currentTime=0,this.currentMusic.pause())}initializeControls(){const t=document.getElementById("music-volume"),e=document.getElementById("sfx-volume"),i=document.getElementById("music-min"),o=document.getElementById("music-max"),s=document.getElementById("sfx-min"),a=document.getElementById("sfx-max");t&&t.addEventListener("input",()=>{k=parseInt(t.value,10)/100,this.currentMusic&&(this.currentMusic.volume=k)}),e&&e.addEventListener("input",()=>{E=parseInt(e.value,10)/100}),i&&t&&i.addEventListener("click",()=>{k=0,t.value="0",this.currentMusic&&(this.currentMusic.volume=0)}),o&&t&&o.addEventListener("click",()=>{k=1,t.value="100",this.currentMusic&&(this.currentMusic.volume=1)}),s&&e&&s.addEventListener("click",()=>{E=0,e.value="0",Object.values(C).forEach(h=>h.volume=0)}),a&&e&&a.addEventListener("click",()=>{E=1,e.value="100",Object.values(C).forEach(h=>h.volume=1)})}}class at{constructor(){this.items=[],this.availableSeeds=[0,1,2,3,4,5,6]}enqueue(...t){this.items.push(...t)}dequeue(){if(this.items.length>0)return this.items.shift();const t=Math.floor(Math.random()*this.availableSeeds.length);return this.availableSeeds[t]}}const f=class f{constructor(){this.bindings=new Map,this.loadBindings()}loadBindings(){const t=localStorage.getItem(f.STORAGE_KEY),e=t?JSON.parse(t):f.DEFAULT_BINDINGS;this.bindings.clear(),e.forEach(i=>{this.bindings.set(i.key.toLowerCase(),i.action)})}getActionForKey(t){return this.bindings.get(t.toLowerCase())}getCurrentBindings(){return Array.from(this.bindings.entries()).map(([t,e])=>({action:e,key:t}))}rebindKey(t,e){const i=e.toLowerCase();for(const[o]of this.bindings.entries())o.toLowerCase()===i&&this.bindings.delete(o);for(const[o,s]of this.bindings.entries())s===t&&this.bindings.delete(o);this.bindings.set(i,t),this.saveBindings()}saveBindings(){localStorage.setItem(f.STORAGE_KEY,JSON.stringify(this.getCurrentBindings()))}};f.STORAGE_KEY="tetris-key-bindings",f.DEFAULT_BINDINGS=[{action:"moveLeft",key:"ArrowLeft"},{action:"moveRight",key:"ArrowRight"},{action:"rotateClockwise",key:"ArrowUp"},{action:"rotateCounterClockwise",key:"z"},{action:"softDrop",key:"ArrowDown"},{action:"hardDrop",key:" "},{action:"hold",key:"h"}];let D=f;const q=750,lt="tick";let T,B=null;ht();function ht(){T=new D;const c=new ct,t={tetrominoDropTime:750,gameRunning:!1,isPaused:!1,board:null,tickIntervalId:null,tetrominoSeedQueue:new at,currentScore:0,scoreBoard:null};c.initializeControls(),c.playMainMenuMusic(),a(),h(),p(),s(),e();function e(){const r=document.querySelector("[data-settings-button]"),l=document.querySelector("[data-key-rebind-menu]"),d=document.querySelector("[data-settings-close]"),u=document.querySelector("[data-rebind-prompt]");if(!r||!l||!d||!u)return;r.addEventListener("click",()=>{l.setAttribute("style","display: flex"),o()}),d.addEventListener("click",()=>{l.setAttribute("style","display: none"),u.style.display="none",B=null}),document.querySelectorAll("[data-action]").forEach(_=>{_.addEventListener("click",w=>{const v=w.currentTarget;if(!v)return;B=v;const g=v.dataset.action;g&&(u.textContent=`Press a key to bind ${g.replace(/([A-Z])/g," $1").toLowerCase()}`,u.style.display="block",document.body.focus())})}),document.addEventListener("keydown",i),o()}function i(r){if(!B)return;const l=B.dataset.action;if(!l||r.key==="Tab"||r.key==="Escape")return;r.preventDefault(),T.rebindKey(l,r.key),o();const d=document.querySelector("[data-rebind-prompt]");d&&(d.style.display="none"),B=null}function o(){T.getCurrentBindings().forEach(l=>{const d=document.querySelector(`[data-current-${l.action}-bind]`);d&&(d.textContent=l.key)})}function s(){const r=document.getElementById("start-button");r&&r.addEventListener("click",()=>{if(t.gameRunning){V();return}U()})}function a(){window.setTetrominoDropTime=function(r){O(r)},window.pushTetrominoSeed=function(...r){t.tetrominoSeedQueue.enqueue(...r)},window.logBoard=function(){t.board&&typeof t.board.log=="function"?t.board.log():console.log("No board available to log.")}}function h(){document.addEventListener("keydown",r=>{(r.key.toLowerCase()==="p"||r.key==="Escape")&&$()})}function p(){const r=document.getElementById("game-board");r&&r.addEventListener("gameover",()=>{M(),c.playSoundEffect("gameOver"),c.stopMusic();const l=document.createElement("div");l.id="game-over",l.className="game-over";const d=document.getElementById("game-board");d&&d.appendChild(l)})}function O(r){t.tetrominoDropTime=r,G()}function U(){t.gameRunning=!0,t.currentScore=0,c.playGameMusic(1),l(),r(),Q(),G();function r(){const u=document.getElementById("start-button");u&&(u.textContent="Reset Game",u.blur())}function l(){const u=d();_(),x();function x(){t.scoreBoard=new I(document.getElementById("score-board"),document.getElementById("level-board"),O,q),t.scoreBoard.setScore(t.currentScore),t.scoreBoard.addEventListener("levelChange",w=>{const v=w,{newLevel:g}=v.detail;c.playSoundEffect("levelUp"),c.handleLevelChange(g)})}function _(){const w=document.querySelector("#hold-board .hold-container"),v=new nt(w);t.board=new st(20,11,document.getElementById("game-board"),u,t.tetrominoSeedQueue,v,T,c),t.board.registerEventListener("linesCompleted",g),t.board.registerEventListener("scoreEvent",Y);function g(S){const b=S.detail.linesCompleted;t.currentScore+=b*(b+1)*50,b>=4?c.playSoundEffect("tetrisClear"):c.playSoundEffect("lineComplete"),t.scoreBoard.setScore(t.currentScore)}function Y(S){const H=S,{points:b}=H.detail;t.currentScore+=b,t.scoreBoard.setScore(t.currentScore)}}}function d(){return new j(document.getElementById("next-board"))}}function $(){if(!t.gameRunning)return;t.isPaused=!t.isPaused,t.board&&t.board.pauseGame();const r=document.getElementById("pause-overlay");r&&(r.style.display=t.isPaused?"block":"none")}function V(){M(),t.gameRunning=!1,t.isPaused=!1,t.currentScore=0,t.tetrominoDropTime=q;const r=document.getElementById("game-over");r&&r.remove();const l=document.getElementById("pause-overlay");l&&(l.style.display="none");const d=document.getElementById("start-button");d&&(d.textContent="Start Game"),t.scoreBoard&&t.scoreBoard.setScore(0),t.board&&(t.board.reset(),t.board.canHoldPiece=!0);const u=document.querySelector("#preview-container");u&&(u.innerHTML="");const x=document.querySelector("#hold-board .hold-container");x&&(x.innerHTML=""),c.playMainMenuMusic()}function G(){M(),t.tickIntervalId=setInterval(()=>{t.isPaused||document.dispatchEvent(new Event(lt))},t.tetrominoDropTime)}function M(){t.tickIntervalId&&(clearInterval(t.tickIntervalId),t.tickIntervalId=null)}function Q(){t.board&&t.board.spawnTetromino()}}
