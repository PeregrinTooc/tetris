if nc -z localhost 5173; then
	echo "Vite server already running."
	SERVER_STARTED=0
else
	npm run dev &
	SERVER_PID=$!
	trap 'kill $SERVER_PID; wait $SERVER_PID' EXIT
	SERVER_STARTED=1
fi

npx wait-on http://localhost:5173

RESULT=$?
if [ $RESULT -ne 0 ]; then
  echo 'Vite server did not start. Push aborted.'
  exit 1
fi

npm test
TEST_RESULT=$?
if [ $TEST_RESULT -ne 0 ]; then
  echo 'Tests failed. Push aborted.'
  exit 1
fi

if [ "$SERVER_STARTED" = "1" ]; then
	kill $SERVER_PID
	wait $SERVER_PID
fi
