# Minimal, clean version
# Check if post-commit.log contains current commit and successful test run
CURRENT_COMMIT=$(git rev-parse HEAD)
if grep -q "Commit: $CURRENT_COMMIT" cypress/post-commit.log && grep -q "E2E tests passed successfully." cypress/post-commit.log; then
	echo "E2E tests already passed for current commit. Skipping tests."
	exit 0
fi

SERVER_STARTED=0
SERVER_PID=""
if nc -z localhost 5173; then
	echo "Vite server already running."
else
	npm run dev &
	SERVER_PID=$!
	SERVER_STARTED=1
fi

wait_for_server() {
	npx wait-on http://localhost:5173
	return $?
}

stop_server() {
	if [ "$SERVER_STARTED" = "1" ] && [ -n "$SERVER_PID" ]; then
		kill $SERVER_PID 2>/dev/null
		wait $SERVER_PID 2>/dev/null || true
	fi
}

wait_for_server
if [ $? -ne 0 ]; then
	echo 'Vite server did not start. Push aborted.'
	stop_server
	exit 1
fi

echo "Running e2e tests before push..."
npm run test:e2e
TEST_RESULT=$?
if [ $TEST_RESULT -ne 0 ]; then
	echo 'E2E tests failed. Push aborted.'
	stop_server
	exit $TEST_RESULT
fi

stop_server
exit 0
