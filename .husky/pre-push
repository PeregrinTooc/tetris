# Minimal, clean version
STARTING_COMMIT=$(git rev-parse HEAD)

# Check if E2E tests have already passed for this commit
if grep -q "Commit: $STARTING_COMMIT" cypress/post-commit.log && grep -q "E2E tests passed successfully." cypress/post-commit.log; then
	echo "E2E tests already passed for current commit. Skipping E2E tests."
	exit 0
fi

SERVER_STARTED=0
SERVER_PID=""
if nc -z localhost 5173; then
	echo "Vite server already running."
else
	npm run dev &
	SERVER_PID=$!
	SERVER_STARTED=1
fi

wait_for_server() {
	npx wait-on http://localhost:5173
	return $?
}

stop_server() {
	if [ "$SERVER_STARTED" = "1" ] && [ -n "$SERVER_PID" ]; then
		kill $SERVER_PID 2>/dev/null
		wait $SERVER_PID 2>/dev/null || true
	fi
}

wait_for_server
if [ $? -ne 0 ]; then
	echo 'Vite server did not start. Push aborted.'
	stop_server
	exit 1
fi

echo "Running e2e tests before push..."
npm run test:e2e
E2E_TEST_RESULT=$?

# Check if commit changed during test run
ENDING_COMMIT=$(git rev-parse HEAD)
if [ "$STARTING_COMMIT" != "$ENDING_COMMIT" ]; then
    echo 'Commit changed during E2E test run. Push aborted.'
    stop_server
    exit 1
fi

if [ $E2E_TEST_RESULT -ne 0 ]; then
    echo 'E2E tests failed. Push aborted.'
    stop_server
    exit $E2E_TEST_RESULT
fi

# Record successful test run
echo "Commit: $STARTING_COMMIT" >> cypress/post-commit.log
echo "E2E tests passed successfully." >> cypress/post-commit.log

stop_server
exit 0
